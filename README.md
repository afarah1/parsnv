Runs a parallel SNV calling pipeline using samtools, bcftools, and vcftools,
aiming for low memory usage.

# Dependencies

You should have GNU Parallel, samtools, bcftools, and vcfutils all in your
PATH. [This docker image](https://hub.docker.com/repository/docker/afarah1/ubuntu-samtools) has everything pre-installed.

Once all dependencies have been met, just download the `parsnv` file and
execute it following the instructions below.

# Usage

`parsnv [options] list`

`list` is a file containing the full path of sequences to run the variant
calling on, as well as reference files. An example is supplied below, as well
as a description of the file contents. The output is written to a file named
`final.vcf` containing the annotated variants for all regions.

## File contents

### CRAM files 

These are the individual samples of aligned sequences. Only CRAM is supported
but the code is easy to adapt to add BAM and SAM support.

If you place index files in the same directory of the .cram files with a
trailing .crai extension they will be recognized and will not be re-indexed.
There is no need to list them, they just have to be on the same path as the
CRAMs.

### FASTA file

A single FASTA file is expected -- the reference genome to which the sequences
are aligned to. The extension should be .fa or .fasta. It can be compressed as
.gz.

###  VCF file 

The variants of the reference genome. The extension should be .vcf.gz (it must
be compressed).

### VCF index 

Index for the reference genome variants. The extension should be .vcf.gz.tbi or
.vcf.gz.csi.

If you do not supply this file the program will atempt to download it from
NCBI. It should be only a few MBs.

## Example

Below is an example file for SNV calling on samples HGDP00525, HGDP00519,
HGDP00711, HGDP00712, HGDP00714, HGDP00715, HGDP00719, and HGDP00777, using
GRCh38 as the reference.

```
/data/HGDP00525.alt_bwamem_GRCh38DH.20181023.French.cram
/data/HGDP00519.alt_bwamem_GRCh38DH.20181023.French.cram
/data/HGDP00711.alt_bwamem_GRCh38DH.20181023.Cambodian.cram
/data/HGDP00712.alt_bwamem_GRCh38DH.20181023.Cambodian.cram
/data/HGDP00714.alt_bwamem_GRCh38DH.20181023.Cambodian.cram
/data/HGDP00715.alt_bwamem_GRCh38DH.20181023.Cambodian.cram
/data/HGDP00719.alt_bwamem_GRCh38DH.20181023.Cambodian.cram
/data/HGDP00777.alt_bwamem_GRCh38DH.20181023.Han.cram
/data/GRCh38_full_analysis_set_plus_decoy_hla.fa
/data/GRCh38_full_analysis_set_plus_decoy_hla.fa.fai
/data/00-All.vcf.gz
/data/00-All.vcf.gz.tbi
```

# Options

The options are as follows.

```
  -i, --indels
    Do not filter out indels on the VCF.

  -f, --filter file
    Reads a custom vcftools filter from a file. Default filter is --max-missing
    0.5 --minDP 5 --min-alleles 2 --max-alleles 2 --minQ 20.

  -h, --help
    Displays a help text.
```

# Troubleshooting

Common errors and how to solve them are described below.

## SAMtools errors

### Corrupt index

```
[main_samview] retrieval of region \"%s\" failed due to truncated file or corrupt BAM index file
```

This means a samtools read failed, likely due to a corrupt index file. This is
a samtools error, not a parsnv error. Try removing all `.crai` files and
running the program again. 

### Corrupt CRAM

```
samtools index: failed to create index for "sample.cram": No such file or directory
```

This means samtools failed to index a CRAM file.  This is a samtools error, not
a parsnv error. The error message generated by samtools can be misleading, the
command did not necessarily fail because it could not find the file, it simply
failed to read them for an unknown reason. parsnv already checks that all
supplied CRAMs are readable, so unless you moved the file after starting parsnv
or changed its permissions, it is likely that the file is corrupt. This is
usually caused by an unfinished download. Check the file size against that of
the FTP source, if they do not match your download did not finish and you have
to download it again -- if a checksum is available, compare the checksums
instead of file size.

## parsnv errors

### Command not found

```
parallel/samtools/bcftools/vcftools: command not found
```

This means you do not have GNU Parallel/etc or it is not on the shell's PATH. Use
the aforementioned docker image or install GNU Parallel/etc and add it to your
PATH.

### Could not find file

```
Could not find FILE on cram list
```

The list is incomplete. Refer to the "Usage" section.

### Could not access file

```
Could not access file FILE
```

The supplied file is not accessible. Check the following:

1. The path is correct (test with `ls`)
2. It is a full path (not a relative path)
3. The file is accessible (check permissions)

# Pipeline

The pipeline is described below. The IO is not actually piped, it is written to
disk and intermediary files are later deleted. This is by design, but may slow
down execution. It is intended to limit memory usage.

The `filter` and `indels` options allow for some minor customization, otherwise
this pipeline is tailored for a certain user's needs, you might need to adjust
this to your own SNV calling configuration. 

## Stage 1 

Here we simply index and view regions for each CRAM.

```
FOR CRAM_J IN LIST DO PARALLEL
  INDEX CRAM_J
  FOR REGION_I IN 1,22 DO
    VIEW CRAM_J REGION_I >CJ_RI
```

## Stage 2 

Merge CRAMs, generate and filter VCFs for each region.

```
FOR REGION_I IN 1,22 DO PARALLEL
  MERGE (CJ_RI FOR J IN LIST)>MERGED_I
  INDEX MERGED_I
  MPILEUP
  CALL
  BCF VIEW
  VCF REMOVE INDELS
  VCF FILTER
```

## Stage 3 

Merge and filter VCFs

```
VCF CONCAT
BCF VIEW
BCF INDEX
BCF ANNOTATE
BCF VIEW
VCF FILTER
```
